$OpenBSD: patch-daemon_gdm-session_c,v 1.26 2021/06/18 22:31:44 ajacoutot Exp $

Index: daemon/gdm-session.c
--- daemon/gdm-session.c.orig
+++ daemon/gdm-session.c
@@ -3241,6 +3241,9 @@ gdm_session_bypasses_xsession (GdmSession *self)
         g_return_val_if_fail (self != NULL, FALSE);
         g_return_val_if_fail (GDM_IS_SESSION (self), FALSE);
 
+#ifdef WITH_CONSOLE_KIT
+        return GDM_SESSION_DISPLAY_MODE_REUSE_VT;
+#else
 #ifdef ENABLE_WAYLAND_SUPPORT
         if (gdm_session_is_wayland_session (self)) {
                 bypasses_xsession = TRUE;
@@ -3271,6 +3274,7 @@ out:
         }
         g_free (filename);
         return bypasses_xsession;
+#endif
 }
 
 GdmSessionDisplayMode
@@ -3334,6 +3338,29 @@ gdm_session_select_program (GdmSession *self,
 
         self->selected_program = g_strdup (text);
 }
+
+#ifdef WITH_CONSOLE_KIT
+void
+gdm_session_select_session_type (GdmSession *self,
+                                 const char *text)
+{
+        GHashTableIter iter;
+        gpointer key, value;
+
+        g_debug ("GdmSession: selecting session type '%s'", text);
+
+        g_hash_table_iter_init (&iter, self->conversations);
+        while (g_hash_table_iter_next (&iter, &key, &value)) {
+                GdmSessionConversation *conversation;
+
+                conversation = (GdmSessionConversation *) value;
+
+                gdm_dbus_worker_call_set_session_type (conversation->worker_proxy,
+                                                       text,
+                                                       NULL, NULL, NULL);
+        }
+}
+#endif
 
 void
 gdm_session_select_session (GdmSession *self,
